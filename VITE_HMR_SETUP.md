# Vite Hot Module Reloading (HMR) Setup

## Summary

Hot Module Reloading allows CSS and JavaScript changes to appear instantly in the browser without rebuilding or refreshing. This project uses the `ddev-vite-sidecar` addon which runs Vite automatically in the background.

## How It Works

The `ddev-vite-sidecar` DDEV addon automatically:

1. Runs Vite dev server when you `ddev start`
2. Creates a dedicated Vite subdomain: `https://vite.zeltlager-kleiner-odenwald.ddev.site`
3. Configures TYPO3 to use the Vite dev server automatically
4. Handles all port management and routing

## Configuration Files

### 1. `.ddev/config.vite.yaml` (Auto-generated by addon)

```yaml
additional_hostnames:
  - vite.zeltlager-kleiner-odenwald
web_environment:
  - VITE_SERVER_URI=https://vite.zeltlager-kleiner-odenwald.ddev.site
  - VITE_PACKAGE_MANAGER=pnpm
```

### 2. `config/system/settings.php` - Vite Asset Collector Configuration

```php
'vite_asset_collector' => [
    'defaultManifest' => '_assets/vite/.vite/manifest.json',
    'devServerUri' => 'https://vite.zeltlager-kleiner-odenwald.ddev.site',
    'useDevServer' => '1',  // Force enable - 'auto' detection may not work reliably
],
```

**Important:** Set `useDevServer` to `'1'` to force-enable the dev server. The `'auto'` mode can fail to detect the Vite server properly.

### 3. `vite.config.js` - Vite Configuration

```javascript
import { defineConfig } from "vite";
import typo3 from "vite-plugin-typo3";

export default defineConfig({
  plugins: [
    typo3({
      input: [
        "packages/thurau_dev/Resources/Private/Scripts/Main.entry.js",
        "packages/thurau_dev/Resources/Private/Styles/Styles.entry.css",
      ],
    }),
  ],
});
```

**Note:** The ddev-vite-sidecar handles server configuration automatically. No need for manual `host` or `port` settings.

## Usage

### Development (with HMR):

```bash
# Just start DDEV - Vite runs automatically!
ddev start
```

Your site is available at `https://zeltlager-kleiner-odenwald.ddev.site` with HMR automatically enabled.

### Production Build:

```bash
pnpm run build
```

## Required DDEV Addons

This project uses:

- **ddev-vite-sidecar** - Automatic Vite dev server management
- **ddev-pnpm** - pnpm package manager support

These are already configured in `.ddev/` directory.

## Troubleshooting

**Assets still loading from `/_assets/vite/`?**

```bash
ddev typo3 cache:flush
# Hard refresh browser (Cmd+Shift+R)
```

## Troubleshooting

**Assets still loading from `/_assets/vite/` instead of Vite dev server?**

This is the most common issue. Verify `useDevServer` is set correctly:

1. Check `config/system/settings.php`:

   ```php
   'useDevServer' => '1',  // Must be '1' not 'auto'
   ```

2. Clear cache:

   ```bash
   ddev typo3 cache:flush
   ```

3. Hard refresh browser (Cmd+Shift+R)

4. Verify assets now load from `https://vite.zeltlager-kleiner-odenwald.ddev.site/`

**Vite not running?**

Check Vite service logs:

```bash
ddev logs -s vite
```

Restart DDEV:

```bash
ddev restart
```

**Changes not appearing?**

- Ensure DDEV is running: `ddev describe`
- Check browser console for connection errors
- Verify assets load from `https://vite.zeltlager-kleiner-odenwald.ddev.site/` not `/_assets/`
- Clear TYPO3 cache: `ddev typo3 cache:flush`

**Need to disable Vite temporarily?**

Edit `.ddev/config.vite.yaml` and restart DDEV, or build production assets:

```bash
pnpm run build
ddev typo3 cache:flush
```

## References

- [ddev-vite-sidecar addon](https://github.com/torenware/ddev-vite-sidecar)
- [TYPO3 vite-asset-collector](https://github.com/s2b/vite-asset-collector)
